<script type="text/javascript">
  var map, infoWindow;
  var markers = [];

  function initialize() {
    <% if missed_connections.size == 1 %>
      var bounds = new google.maps.LatLngBounds();
    <% end %>
    var mapOptions = {
      zoom: 14,
      center: new google.maps.LatLng(40.706709, -73.923516)
    };
    map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);

    <% missed_connections.each do |missed_connection| %>
      var position = new google.maps.LatLng(<%= missed_connection.latitude %>, <%= missed_connection.longitude %>);
      <% if missed_connections.size == 1 %>
        bounds.extend(position);
      <% end %>

      marker = new google.maps.Marker({
        position: position,
        map: map,
        title: '<%= missed_connection.title %>'
      });
      markers.push(marker);

      infoWindow = new google.maps.InfoWindow(), marker;

      google.maps.event.addListener(marker, 'click', (function(marker) {
        return function() {
          infoWindow.setContent('<%= escape_javascript(render 'info_window', missed_connection: missed_connection) %>');
          infoWindow.open(map, marker);
        }
      })(marker));

      <% if missed_connections.size == 1 %>
        map.fitBounds(bounds);
      <% end %>

    <% end %>
  }

  google.maps.event.addDomListener(window, 'load', initialize);
</script>
