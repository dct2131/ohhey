var App = {
  markers: []
};

function initialize() {
  <% if missed_connections.size == 1 %>
    var bounds = new google.maps.LatLngBounds();
  <% end %>
  var mapOptions = {
    zoom: 14,
    center: new google.maps.LatLng(40.706709, -73.923516)
  };
  App.map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);

  <% missed_connections.each do |missed_connection| %>
    var position = new google.maps.LatLng(<%= missed_connection.latitude %>, <%= missed_connection.longitude %>);
    <% if missed_connections.size == 1 %>
      bounds.extend(position);
    <% end %>

    marker = new google.maps.Marker({
      position: position,
      map: App.map,
      title: '<%= missed_connection.title %>',
      missedConnectionId: <%= missed_connection.id %>
    });

    App.markers.push(marker);

    infoWindow = new google.maps.InfoWindow(), marker;

    google.maps.event.addListener(marker, 'click', (function(marker) {
      return function() {
        $('.missed-connection[data-missed-connection-id]').removeClass('active');
        $('.missed-connection[data-missed-connection-id="' + marker.missedConnectionId + '"]').addClass('active');
        infoWindow.setContent('<%= escape_javascript(render '/shared/info_window', missed_connection: missed_connection) %>');
        infoWindow.open(App.map, marker);
        var position = new google.maps.LatLng(<%= missed_connection.latitude %>, <%= missed_connection.longitude %>);
        App.map.panTo(position);
        App.map.setZoom(15);
      }
    })(marker));

    google.maps.event.addListener(infoWindow, 'closeclick', (function(marker) {
      return function() {
        $('.missed-connection[data-missed-connection-id]').removeClass('active');
      }
    })(marker));

    <% if missed_connections.size == 1 %>
      App.map.fitBounds(bounds);
    <% end %>

  <% end %>
}

google.maps.event.addDomListener(window, 'load', initialize);
